generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Clients (Les Broderies de Paris, Scalefast, etc.)
model Client {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  slug            String    @unique
  persona         Json?     // Données du persona (nom, âge, problèmes, etc.)
  brandGuidelines Json?     @map("brand_guidelines") // Charte graphique, ton, mots interdits
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  projects Project[]

  @@map("clients")
}

// Projets (un article = un projet)
model Project {
  id            String   @id @default(uuid()) @db.Uuid
  clientId      String   @map("client_id") @db.Uuid
  title         String
  keyword       String   // Mot-clé principal
  searchIntents String[] @map("search_intents") // Intentions de recherche
  status        String   @default("draft") // draft, in_progress, completed, published
  currentStep   Int      @default(0) @map("current_step")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  client        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  workflowSteps WorkflowStep[]
  images        GeneratedImage[]
  apiUsageLogs  ApiUsageLog[]

  @@map("projects")
}

// Étapes du workflow (output de chaque étape)
model WorkflowStep {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  stepNumber  Int       @map("step_number") // 0 à 15
  stepName    String    @map("step_name")
  inputData   Json?     @map("input_data")  // Données d'entrée (prompt variables)
  outputData  Json?     @map("output_data") // Résultat généré
  outputText  String?   @map("output_text") // Texte brut (pour recherche)
  isValidated Boolean   @default(false) @map("is_validated")
  validatedAt DateTime? @map("validated_at")
  tokensUsed  Int?      @map("tokens_used")
  costUsd     Decimal?  @map("cost_usd") @db.Decimal(10, 6)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  project Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  images  GeneratedImage[]

  @@unique([projectId, stepNumber])
  @@map("workflow_steps")
}

// Templates de prompts (personnalisables)
model PromptTemplate {
  id                 String   @id @default(uuid()) @db.Uuid
  stepNumber         Int      @map("step_number")
  stepName           String   @map("step_name")
  systemPrompt       String   @map("system_prompt")
  userPromptTemplate String   @map("user_prompt_template") // Avec variables {{keyword}}, {{persona}}, etc.
  isActive           Boolean  @default(true) @map("is_active")
  version            Int      @default(1)
  createdAt          DateTime @default(now()) @map("created_at")

  @@map("prompt_templates")
}

// Images générées
model GeneratedImage {
  id        String   @id @default(uuid()) @db.Uuid
  projectId String   @map("project_id") @db.Uuid
  stepId    String?  @map("step_id") @db.Uuid
  prompt    String
  imageUrl  String?  @map("image_url") // Chemin local ou URL
  altText   String?  @map("alt_text")
  filename  String?
  createdAt DateTime @default(now()) @map("created_at")

  project Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  step    WorkflowStep? @relation(fields: [stepId], references: [id])

  @@map("generated_images")
}

// Logs d'utilisation API (pour suivi des coûts)
model ApiUsageLog {
  id           String   @id @default(uuid()) @db.Uuid
  projectId    String?  @map("project_id") @db.Uuid
  provider     String   // 'anthropic', 'openai'
  model        String
  inputTokens  Int?     @map("input_tokens")
  outputTokens Int?     @map("output_tokens")
  costUsd      Decimal? @map("cost_usd") @db.Decimal(10, 6)
  createdAt    DateTime @default(now()) @map("created_at")

  project Project? @relation(fields: [projectId], references: [id])

  @@map("api_usage_logs")
}
